{% extends 'admin_dashboard.html' %}
{% block title %}View Data{% endblock %}
{% block content %}


  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <style>

    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f7fa;
    }

    .navbar-brand {
      font-weight: 600;
      font-size: 20px;
    }

    .nav-item .nav-link {
      font-weight: 500;
    }

    .user-info {
      font-size: 0.9rem;
      color: #fff;
      background: #198754;
      border-radius: 20px;
      padding: 4px 12px;
      margin-left: auto;
      margin-right: 10px;
    }

.table-container {
  max-height: 70vh;
  overflow-y: auto;
  border: 1px solid #ccc;
}

th, td {
  white-space: nowrap;
  text-align: left !important;
  vertical-align: middle !important;
}

thead th {
  background-color: #343a40;
  color: white;
  position: sticky;
  top: 0;
  z-index: 1;
}

.btn-outline-success, .btn-outline-primary {
  font-weight: 500;
  border-radius: 20px;
}

.table td, .table th {
  padding: 0.75rem 1rem;
  font-size: 14px;
}
  </style>


<div class="container py-4">

  {% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}


<div class="d-flex flex-wrap align-items-center gap-2 mb-3">
  <!-- Date Filter -->
  <input type="date" id="dateFilter" class="form-control" style="width: 160px;" placeholder="Date">

  <!-- Text Search -->
  <input type="text" id="searchInput" class="form-control" style="flex: 1;" placeholder="Search...">

  <!-- Download Button -->
  <a href="/download_ticket_list" class="btn btn-outline-success d-flex align-items-center">
    <i class="bi bi-arrow-down-circle-fill me-1"></i> Download CSV
  </a>
</div>




  <div class="table-container">
    
  <table class="table table-bordered table-hover align-middle text-center" id="ticketTable">
    <thead>
      <tr>
        <th>Date</th>
        <th>Time</th>
        <th>Agent</th>
        <th>Ticket</th>
        <th>Ref</th>
        <th>License</th>
        <th>Company</th>
        <th>Server</th>
        <th>Contact</th>
        <th>Lang</th>
        <th>Type</th>
        <th>Query</th>
        <th>Status</th>
        <th>Duration</th>
        <th>Rating</th>
        <th>Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for row in call_data %}
      <tr>
        <td>{{ row['date'] }}</td>
        <td>{{ row['time'] }}</td>
        <td>{{ row['agent_name'] }}</td>
        <td>{{ row['ticket_no'] }}</td>
        <td>{{ row['ref_ticket_no'] }}</td>
        <td>{{ row['company_license'] }}</td>
        <td>{{ row['company_name'] }}</td>
        <td>{{ row['company_server'] }}</td>
        <td>{{ row['contact'] }}</td>
        <td>{{ row['language'] }}</td>
        <td>{{ row['query_type'] }}</td>
        <td>{{ row['query'] }}</td>
        <td>
          <span class="badge {{ 'bg-success' if row['status'] == 'Completed' else 'bg-warning text-dark' }}">
            {{ row['status'] }}
          </span>
        </td>
        <td>{{ row['duration'] }}</td>
        <td>{{ row['rating'] }}</td>
        <td>
        <!-- ðŸ“ Edit Button -->
        <button 
          class="btn btn-sm btn-outline-primary me-1"
          data-bs-toggle="modal" 
          data-bs-target="#editTicketModal{{ row['id'] }}"
          title="Edit"
          title="Edit"
          data-id="{{ row['id'] }}"
          data-ticket="{{ row['ticket_no'] }}"
          data-license="{{ row['company_license'] }}"
          data-company="{{ row['company_name'] }}"
          data-server="{{ row['company_server'] }}"
          data-contact="{{ row['contact'] }}"
          data-query="{{ row['query'] }}"
          data-status="{{ row['status'] }}"
          data-duration="{{ row['duration'] }}"
        >
          <i class="bi bi-pencil-square"></i>
        </button>

        <!-- ðŸ—‘ï¸ Delete Button -->
        <form action="/delete_ticket/{{ row['id'] }}" method="POST" class="d-inline" onsubmit="return confirm('Are you sure you want to delete this ticket?');">
          <button class="btn btn-sm btn-outline-danger" title="Delete Ticket">
            <i class="bi bi-trash-fill"></i>
          </button>
        </form>
        </td>
      </tr>

      <!-- Edit Modal -->
<div class="modal fade" id="editTicketModal{{ row['id'] }}" tabindex="-1">
  <div class="modal-dialog modal-lg modal-dialog-scrollable modal-lg">
    <div class="modal-content">
      <form action="/edit_ticket/{{ row['id'] }}" method="POST">
        <div class="modal-header bg-warning text-dark">
          <h5 class="modal-title"><i class="bi bi-pencil-square me-1"></i> Edit Ticket {{ row['license_number'] }}</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body row g-3 px-3" style="max-height: 70vh; overflow-y: auto;">
          {% for field, label in {
            'date': 'Date',
            'time': 'Time',
            'agent_name': 'Agent',
            'ticket_no': 'Ticket',
            'ref_ticket_no': 'Ref Ticket',
            'company_license': 'License',
            'company_name': 'Company',
            'company_server': 'Server',
            'contact': 'Contact',
            'language': 'Language',
            'query_type': 'Type',
            'query': 'Query',
            'status': 'Status',
            'duration': 'Duration',
            'rating': 'Rating'
          }.items() %}
            <div class="col-md-6">
              <label class="form-label">{{ label }}</label>
              {% if field == 'query' %}
                <textarea class="form-control" name="{{ field }}">{{ row[field] }}</textarea>
              {% elif field == 'status' %}
                <select class="form-select" name="status">
                  <option value="Completed" {% if row['status'] == 'Completed' %}selected{% endif %}>Completed</option>
                  <option value="Underprocessing" {% if row['status'] == 'Underprocessing' %}selected{% endif %}>Underprocessing</option>
                  <option value="Informed to Dev Team" {% if row['status'] == 'Informed to Dev Team' %}selected{% endif %}>Informed to Dev Team</option>
                  <option value="Informed to Sales Team" {% if row['status'] == 'Informed to Sales Team' %}selected{% endif %}>Informed to Sales Team</option>
                  <option value="Informed to Accounts Team" {% if row['status'] == 'Informed to Accounts Team' %}selected{% endif %}>Informed to Accounts Team</option>
                  <option value="Other" {% if row['status'] == 'Other' %}selected{% endif %}>Other</option>
                  <option value="NA" {% if row['status'] == 'NA' %}selected{% endif %}>NA</option>
                </select>
              {% else %}
                <input type="text" class="form-control" name="{{ field }}" value="{{ row[field] }}">
              {% endif %}
            </div>
          {% endfor %}
        </div>
        <div class="modal-footer px-3">
          <button type="submit" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>


<!-- Delete Modal -->
<div class="modal fade" id="deleteTicketModal" tabindex="-1" aria-labelledby="deleteTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form method="POST" action="/delete_ticket/{{ row['id'] }}">
      <div class="modal-content">
        <div class="modal-header bg-danger text-white">
          <h5 class="modal-title" id="deleteTicketModalLabel">Delete Confirmation</h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body text-center">
          <input type="hidden" name="id" id="delete-id">
          <p class="mb-0">Are you sure you want to delete this ticket?</p>
        </div>
        <div class="modal-footer justify-content-center">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger">Yes, Delete</button>
        </div>
      </div>
    </form>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<script>
  
  const deleteModal = document.getElementById('deleteTicketModal');
  deleteModal.addEventListener('show.bs.modal', function (event) {
    const button = event.relatedTarget;
    document.getElementById('delete-id').value = button.getAttribute('data-id');
  });
</script>


      {% endfor %}
    </tbody>
  </table>
  </div>
</div>

<script>
  const searchInput = document.getElementById('searchInput');
  const dateFilter = document.getElementById('dateFilter');
  const table = document.getElementById('ticketTable');
  const rows = table.getElementsByTagName('tbody')[0].getElementsByTagName('tr');

  function filterTable() {
    const searchValue = searchInput.value.toLowerCase();
    const dateValue = dateFilter.value;

    for (let row of rows) {
      const rowText = row.innerText.toLowerCase();
      const dateMatch = dateValue === "" || row.cells[0].innerText === dateValue;
      const searchMatch = rowText.includes(searchValue);
      row.style.display = (searchMatch && dateMatch) ? "" : "none";
    }
  }

  searchInput.addEventListener('keyup', filterTable);
  dateFilter.addEventListener('change', filterTable);
</script>


{% endblock %}
